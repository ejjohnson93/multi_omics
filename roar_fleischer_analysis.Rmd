

Load libraries

```{r}

library(tidyverse)

```


Read in data:

```{r}

data <- read.csv("fleischer_sep_roar_results.csv", header = TRUE)
data <- as.matrix(data)

```


Read in meta-data data:

```{r}

metadata <- read.csv("fleischer_metadata.csv", header = TRUE)

```

Format data for preliminary analysis. First extract only columns with data.
Then convert matrix into a numeric type, before converting to dataframe. 
Add additional column with gene names.


```{r}

data_plain <- data[,c(1:136,139:274)]
mode(data_plain) = "numeric"
data_plain <- data.frame(data_plain)
data_plain$gene_ID <- data[,138]

```

Remove rows corresponding to NA values for gene names.
Then use gene names for rownames. 

```{r}

data_plain <- data_plain[!duplicated(data_plain$gene_ID), ]
data_plain <- data_plain[!is.na(data_plain$gene_ID), ]
rownames(data_plain) <- data_plain$gene_ID

```

Seperate the TPM data and ratio data. Filter the TPM data to exclude counts below 2. 
Use the newly fitlered TPM data to subset the ratio data. 
Then further filter that ratio data to remove outliers. 

```{r}

data_plain_TPM <- data_plain[,137:272]


for(i in 1:ncol(data_plain_TPM)){
    data_plain_TPM <- data_plain_TPM %>% filter(., .[i] > 2)
   
}



data_plain_ratio <- data_plain[,1:136]
data_plain_ratio <- data_plain_ratio[rownames(data_plain_ratio) %in% rownames(data_plain_TPM),]



for(i in 1:ncol(data_plain_ratio)){
    data_plain_ratio <- data_plain_ratio %>% filter(., .[i] > 0 & .[i] <20)
   
}


```


```{r}
metadata_original <- metadata
metadata <- metadata %>% dplyr::select("age", "sex", "disease", "source_name", "ethnicity") %>% mutate(
    Age_group = case_when(
    age >= 60 ~ "Old",
    age > 30 & age < 60 ~ "Middle-aged",
    age <= 30 ~ "Young"
    ))

rownames(metadata) <- metadata_original$Run

metadata[127:136,6] <- "HPS"

metadata[127,1] <- 8
metadata[128,1] <- 8
metadata[129,1] <- 2.25
metadata[130,1] <- 3.75
metadata[131,1] <- 3.75
metadata[132,1] <- 3.75
metadata[133,1] <- 3.75
metadata[134,1] <- 3.75
metadata[135,1] <- 3.75
metadata[136,1] <- 3.75

metadata$age <- as.numeric(metadata$age)

```

Look at boxplots/distribution: 

```{r}

boxplot(data_plain_ratio,ylab="Ratio",xlab="Sample")

```

```{r}

plot(density(data_plain_ratio[,1]), ylim=c(0,0.7), xlim=c(-1,20))
for(i in 2:ncol(data_plain_ratio)) { lines(density(data_plain_ratio[,i])) }

```

```{r}

boxplot(log2(data_plain_TPM),ylab="TPM",xlab="Sample")

```

Ratio results: 

```{r}

pca_res <- prcomp(t(data_plain_ratio), scale. = TRUE)

df_out <- as.data.frame(pca_res$x)
p<-ggplot(df_out,aes(x=PC1,y=PC2,color=metadata$Age_group ))
p<-p+geom_point()
p


```


TPM results: 


```{r}

pca_res <- prcomp(t(data_plain_TPM), scale. = TRUE)

df_out <- as.data.frame(pca_res$x)
p<-ggplot(df_out,aes(x=PC1,y=PC2,color=metadata$Age_group ))
p<-p+geom_point()
p


```


Now extract collagen specific data:


```{r}

COL1A1 <- data_plain["COL1A1",-ncol(data_plain)]
COL1A2 <- data_plain["COL1A2",-ncol(data_plain)]

col_df <- t(rbind(COL1A1, COL1A2))

ratio <- as.data.frame(col_df[grepl("ratio", rownames(col_df)), ])
TPM <- as.data.frame(col_df[grepl("TPM", rownames(col_df)), ])

rownames(TPM) <-  gsub(pattern = "_.*",
                                    replacement = "",
                                    x = rownames(TPM))

rownames(ratio) <- gsub(pattern = "_.*",
                                    replacement = "",
                                    x = rownames(ratio))

col_df <- cbind(TPM, ratio)
colnames(col_df) <- c("COL1A1_TPM", "COL1A2_TPM", "COL1A1_ratio", "COL1A2_ratio")


```


```{r}

col_df <- col_df %>% mutate(
    COL1A1_short_form = COL1A1_TPM/(COL1A1_ratio+1)*COL1A1_ratio,
    COL1A1_long_form = COL1A1_TPM/(COL1A1_ratio+1),
    COL1A2_short_form = COL1A2_TPM/(COL1A2_ratio+1)*COL1A2_ratio,
    COL1A2_long_form = COL1A2_TPM/(COL1A2_ratio+1)) %>% add_column(metadata$Age_group, metadata$sex)

# (round(test$COL1A2_long_form) + round(test$COL1A2_short_form)) == round(test$COL1A2_TPM)

```


```{r}

write.csv(col_df, "./fleischer_collagen_data.csv")

```



